<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bilderrahmen</title>
    <style>
        body { margin: 0; background-color: #000; overflow: hidden; height: 100vh; width: 100vw; }
        
        /* Container für die Medien */
        .media-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 1.5s ease-in-out;
        }

        .media-container.visible { opacity: 1; }

        img, video {
            max-width: 100%; max-height: 100%; width: auto; height: auto;
            object-fit: contain;
        }
    </style>
</head>
<body>

    <div id="container1" class="media-container visible"></div>
    <div id="container2" class="media-container"></div>

    <script>
        var mediaList = [];
        var currentIndex = 0;
        var activeContainerId = 'container1';
        var defaultDuration = 10000; // 10 Sekunden für Bilder

        function fetchMediaList() {
            fetch('/api/images')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) mediaList = data;
                });
        }

        function playNext() {
            if (mediaList.length === 0) {
                setTimeout(playNext, 2000);
                return;
            }

            currentIndex = (currentIndex + 1) % mediaList.length;
            var item = mediaList[currentIndex];
            var timestamp = new Date().getTime(); // Cache buster
            var url = "/static/images/" + item.url + "?t=" + timestamp;

            // Welcher Container ist gerade NICHT sichtbar? (Buffer)
            var nextContainerId = (activeContainerId === 'container1') ? 'container2' : 'container1';
            var nextContainer = document.getElementById(nextContainerId);
            var currentContainer = document.getElementById(activeContainerId);

            // Inhalt leeren und neu befüllen
            nextContainer.innerHTML = '';
            
            var mediaElement;

            if (item.type === 'video') {
                mediaElement = document.createElement('video');
                mediaElement.src = url;
                mediaElement.muted = true; // Wichtig für Autoplay
                mediaElement.playsInline = true; // Wichtig für iOS
                mediaElement.autoplay = true;
                
                // Wenn Video geladen ist, anzeigen
                mediaElement.oncanplay = function() {
                    performTransition(currentContainer, nextContainer, mediaElement, true);
                };
                
                // Wenn Fehler beim Video, überspringen
                mediaElement.onerror = function() {
                    setTimeout(playNext, 1000);
                };

            } else {
                mediaElement = document.createElement('img');
                mediaElement.src = url;
                
                mediaElement.onload = function() {
                    performTransition(currentContainer, nextContainer, mediaElement, false);
                };
            }
            
            nextContainer.appendChild(mediaElement);
        }

        function performTransition(oldDiv, newDiv, element, isVideo) {
            newDiv.classList.add('visible');
            oldDiv.classList.remove('visible');
            activeContainerId = newDiv.id;

            if (isVideo) {
                // Video abspielen und warten bis Ende
                element.play().catch(e => console.log("Autoplay blocked", e));
                element.onended = function() {
                    playNext();
                };
            } else {
                // Bild: Einfach Timer warten
                setTimeout(playNext, defaultDuration);
            }
        }

        // Start
        fetchMediaList();
        setInterval(fetchMediaList, 30000);
        setTimeout(playNext, 1000);

    </script>
</body>
</html>