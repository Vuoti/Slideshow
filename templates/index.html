<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bilderrahmen</title>
    <style>
        body { 
            margin: 0; 
            background: #000; 
            overflow: hidden; 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        
        /* Die Container für Bilder/Videos (Quadratisch) */
        .media-container { 
            position: absolute; 
            width: 100vmin; 
            height: 100vmin; 
            opacity: 0; 
            transition: opacity 1.5s ease-in-out; 
            background: #000; 
        }
        
        .media-container.visible { opacity: 1; }
        
        img, video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block; 
        }

        /* Das Helligkeits-Overlay (Software-Dimming) */
        #brightness-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            pointer-events: none; /* Klicks gehen durch */
            z-index: 9999; /* Immer ganz oben */
            opacity: 0; /* Standard: Transparent */
            transition: opacity 2s ease-in-out; /* Weicher Helligkeitswechsel */
        }
    </style>
</head>
<body>
    <div id="brightness-overlay"></div>

    <div id="container1" class="media-container visible"></div>
    <div id="container2" class="media-container"></div>

    <script>
        var allMedia = [];      // Alle Bilder vom Server
        var playlist = [];      // Die aktuell abgespielte Liste (gefiltert)
        var currentIndex = -1;
        var activeContainerId = 'container1';
        
        // Defaults (werden vom Server überschrieben)
        var config = { 
            duration: 10, 
            mode: 'slideshow', 
            newest_count: 5, 
            brightness: 100, 
            night_mode: false, 
            night_start: "22:00", 
            night_end: "07:00", 
            night_brightness: 20,
            night_duration: 30 
        };

        function fetchConfigAndImages() {
            // Config und Bilder parallel laden
            Promise.all([
                fetch('/api/config').then(r => r.json()),
                fetch('/api/images').then(r => r.json())
            ]).then(([newConfig, newImages]) => {
                config = newConfig;
                if (newImages.length) allMedia = newImages;
                
                updatePlaylist();
                updateBrightness(); // Helligkeit sofort prüfen
            });
        }

        // Entscheidet welche Bilder gezeigt werden (Alle vs. Neueste X)
        function updatePlaylist() {
            if (config.mode === 'newest') {
                // Nur die ersten X Bilder nehmen
                playlist = allMedia.slice(0, config.newest_count);
            } else {
                // Alle Bilder nehmen
                playlist = allMedia;
            }
        }

        function isNightTime() {
            if (!config.night_mode) return false;

            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            if (!config.night_start || !config.night_end) return false;

            const [startH, startM] = config.night_start.split(':').map(Number);
            const [endH, endM] = config.night_end.split(':').map(Number);
            
            const startTotal = startH * 60 + startM;
            const endTotal = endH * 60 + endM;

            // Logik für Zeitfenster (auch über Mitternacht hinaus, z.B. 22:00 bis 07:00)
            if (startTotal < endTotal) {
                // Z.B. 09:00 bis 17:00
                return currentMinutes >= startTotal && currentMinutes < endTotal;
            } else {
                // Z.B. 22:00 bis 07:00 (geht über Mitternacht)
                return currentMinutes >= startTotal || currentMinutes < endTotal;
            }
        }

        function updateBrightness() {
            let targetBrightness = config.brightness;

            if (isNightTime()) {
                targetBrightness = config.night_brightness;
            }

            // Helligkeit in Opacity umrechnen
            // 100% Helligkeit = 0% Schwarz-Overlay
            // 20% Helligkeit = 80% Schwarz-Overlay
            const opacity = 1 - (targetBrightness / 100);
            document.getElementById('brightness-overlay').style.opacity = opacity;
        }

        function playNext() {
            if (playlist.length === 0) { setTimeout(playNext, 2000); return; }

            // Nächstes Bild wählen
            let nextIndex = (currentIndex + 1) % playlist.length;
            
            // Falls Playlist kürzer wurde (z.B. Einstellung geändert von 10 auf 3 Bilder)
            if (nextIndex >= playlist.length) nextIndex = 0;

            var item = playlist[nextIndex];
            currentIndex = nextIndex;

            var nextContainerId = (activeContainerId === 'container1') ? 'container2' : 'container1';
            var nextDiv = document.getElementById(nextContainerId);
            var currentDiv = document.getElementById(activeContainerId);
            
            nextDiv.innerHTML = '';
            var el;
            
            // --- DAUER LOGIK ---
            // Standard-Dauer
            var targetDuration = config.duration;

            // Wenn Nachtmodus aktiv UND wir im Zeitfenster sind -> Nachtdauer nehmen
            if (isNightTime()) {
                // Fallback auf normale Dauer, falls night_duration fehlt
                targetDuration = config.night_duration || config.duration;
            }
            
            var slideDuration = targetDuration * 1000; 

            // --- MEDIEN LOGIK ---
            if (item.type === 'video') {
                el = document.createElement('video');
                el.src = "/static/images/" + item.url;
                el.muted = true; el.autoplay = true; el.playsInline = true;
                el.style.objectPosition = "center center"; 
                
                el.oncanplay = () => {
                   nextDiv.classList.add('visible');
                   currentDiv.classList.remove('visible');
                   activeContainerId = nextDiv.id;
                   el.play().catch(e => console.log("Autoplay blocked", e));
                };

                // Wenn Modus "Newest" ist, Video loopen. Sonst nächstes Bild.
                if (config.mode === 'newest' && playlist.length === 1) {
                    el.loop = true;
                    // Trotzdem prüfen wir ab und zu auf neue uploads
                    setTimeout(playNext, 60000); 
                } else {
                    el.onended = playNext;
                }
                
                el.onerror = () => setTimeout(playNext, 1000);

            } else {
                el = document.createElement('img');
                el.src = "/static/images/" + item.url;
                // Smart Crop Position anwenden
                el.style.objectPosition = item.focus_x + "% " + item.focus_y + "%";
                
                el.onload = () => {
                   nextDiv.classList.add('visible');
                   currentDiv.classList.remove('visible');
                   activeContainerId = nextDiv.id;
                   setTimeout(playNext, slideDuration);
                };
                el.onerror = () => setTimeout(playNext, 1000);
            }
            nextDiv.appendChild(el);
        }

        // Init
        fetchConfigAndImages();
        
        // Regelmäßige Checks
        setInterval(fetchConfigAndImages, 15000); // Alle 15 sek prüfen ob Settings/Bilder neu sind
        setInterval(updateBrightness, 60000);     // Jede Minute: Ist es jetzt Nacht?
        
        setTimeout(playNext, 1000);
    </script>
</body>
</html>