<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bilderrahmen</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        .media-container { position: absolute; width: 100vmin; height: 100vmin; opacity: 0; transition: opacity 1.5s ease-in-out; background: #000; }
        .media-container.visible { opacity: 1; }
        img, video { width: 100%; height: 100%; object-fit: cover; display: block; }
    </style>
</head>
<body>
    <div id="container1" class="media-container visible"></div>
    <div id="container2" class="media-container"></div>

    <script>
        var mediaList = [];
        var currentIndex = -1; // Startwert
        var activeContainerId = 'container1';
        
        // Standardwerte (werden vom Server überschrieben)
        var config = { duration: 10, mode: 'slideshow' };

        function fetchConfigAndImages() {
            // 1. Config laden
            fetch('/api/config').then(r => r.json()).then(data => { config = data; });

            // 2. Bilder laden
            fetch('/api/images').then(r => r.json()).then(data => { 
                if (data.length) mediaList = data; 
            });
        }

        function playNext() {
            if (mediaList.length === 0) { setTimeout(playNext, 2000); return; }

            let nextIndex;

            // --- MODUS LOGIK ---
            if (config.mode === 'newest') {
                // Immer das allererste Bild (das Neueste) anzeigen
                nextIndex = 0;
                
                // Optimierung: Wenn wir schon das neuste Bild zeigen und es kein Video ist, nichts tun
                // (Verhindert unnötiges Neuladen/Flackern bei "Newest Only")
                if (currentIndex === 0 && mediaList[0].type !== 'video' && document.querySelector('.visible img')) {
                    setTimeout(playNext, 5000); // Einfach warten und später prüfen ob was neues kam
                    return; 
                }
            } else {
                // Slideshow: Einfach hochzählen
                nextIndex = (currentIndex + 1) % mediaList.length;
            }

            var item = mediaList[nextIndex];
            currentIndex = nextIndex; // Merken wo wir sind

            var nextContainerId = (activeContainerId === 'container1') ? 'container2' : 'container1';
            var nextDiv = document.getElementById(nextContainerId);
            var currentDiv = document.getElementById(activeContainerId);
            
            nextDiv.innerHTML = '';
            var el;
            
            // --- DAUER LOGIK ---
            // Videos haben ihre eigene Dauer, Bilder nutzen die Config
            var slideDuration = config.duration * 1000; 

            if (item.type === 'video') {
                el = document.createElement('video');
                el.src = "/static/images/" + item.url;
                el.muted = true; el.autoplay = true; el.playsInline = true;
                el.style.objectPosition = "center center"; 
                
                el.oncanplay = () => {
                   nextDiv.classList.add('visible');
                   currentDiv.classList.remove('visible');
                   activeContainerId = nextDiv.id;
                   el.play().catch(e => console.log("Autoplay blocked", e));
                };
                
                // Wenn Modus "Newest" ist, Video loopen. Sonst nächstes Bild.
                if (config.mode === 'newest') {
                    el.loop = true;
                    // Trotzdem prüfen wir ab und zu auf neue uploads
                    setTimeout(playNext, 60000); 
                } else {
                    el.onended = playNext;
                }
                
                el.onerror = () => setTimeout(playNext, 1000);

            } else {
                el = document.createElement('img');
                el.src = "/static/images/" + item.url;
                el.style.objectPosition = item.focus_x + "% " + item.focus_y + "%";
                
                el.onload = () => {
                   nextDiv.classList.add('visible');
                   currentDiv.classList.remove('visible');
                   activeContainerId = nextDiv.id;
                   setTimeout(playNext, slideDuration);
                };
                el.onerror = () => setTimeout(playNext, 1000);
            }
            nextDiv.appendChild(el);
        }

        // Init
        fetchConfigAndImages();
        setInterval(fetchConfigAndImages, 15000); // Alle 15 sek prüfen ob Settings/Bilder neu sind
        setTimeout(playNext, 1000);
    </script>
</body>
</html>