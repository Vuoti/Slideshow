<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bilderrahmen</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        .media-container {
            position: absolute; width: 80vmin; height: 80vmin;
            opacity: 0; transition: opacity 1.5s ease-in-out;
            background: #000; /* Verhindert Blitzen beim Wechsel */
        }
        .media-container.visible { opacity: 1; }

        img, video {
            width: 100%; height: 100%;
            object-fit: cover; 
            display: block;
        }
    </style>
</head>
<body>
    <div id="container1" class="media-container visible"></div>
    <div id="container2" class="media-container"></div>

    <script>
        var mediaList = [];
        var currentIndex = 0;
        var activeContainerId = 'container1';

        function fetchMediaList() {
            fetch('/api/images')
                .then(r => r.json()).then(data => { if (data.length) mediaList = data; });
        }

        function playNext() {
            if (mediaList.length === 0) { setTimeout(playNext, 2000); return; }

            currentIndex = (currentIndex + 1) % mediaList.length;
            var item = mediaList[currentIndex];
            
            var nextContainerId = (activeContainerId === 'container1') ? 'container2' : 'container1';
            var nextDiv = document.getElementById(nextContainerId);
            var currentDiv = document.getElementById(activeContainerId);
            
            // Container leeren und bereit machen
            nextDiv.innerHTML = '';
            
            var el;
            
            // --- VIDEO LOGIK ---
            if (item.type === 'video') {
                el = document.createElement('video');
                el.src = "/static/images/" + item.url;
                el.muted = true;    // Pflicht für Autoplay
                el.autoplay = true; 
                el.playsInline = true; // Pflicht für iOS
                el.style.objectPosition = "center center"; 
                
                // WICHTIG: Sobald das Video bereit ist -> Sichtbar machen
                el.oncanplay = () => {
                   nextDiv.classList.add('visible');
                   currentDiv.classList.remove('visible');
                   activeContainerId = nextDiv.id;
                   
                   // Video starten (sicherheitshalber explizit)
                   el.play().catch(e => console.log("Autoplay blocked:", e));
                };

                el.onended = playNext;
                el.onerror = () => { console.log("Video error"); setTimeout(playNext, 1000); };
            
            // --- BILD LOGIK ---
            } else {
                el = document.createElement('img');
                el.src = "/static/images/" + item.url;
                
                // Crop Position aus der API anwenden
                el.style.objectPosition = item.focus_x + "% " + item.focus_y + "%";
                
                el.onload = () => {
                   nextDiv.classList.add('visible');
                   currentDiv.classList.remove('visible');
                   activeContainerId = nextDiv.id;
                   setTimeout(playNext, 10000); // 10 Sekunden Anzeigedauer für Bilder
                };
                
                el.onerror = () => setTimeout(playNext, 1000);
            }
            
            nextDiv.appendChild(el);
        }

        // Start
        fetchMediaList();
        setInterval(fetchMediaList, 30000); // Liste alle 30 sek aktualisieren
        setTimeout(playNext, 1000);
    </script>
</body>
</html>