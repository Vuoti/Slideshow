<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bilderrahmen</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; height: 100vh; display: flex; justify-content: center; }
        .media-container { position: absolute; width: 100vmin; height: 115vmin; opacity: 0; transition: opacity 1.5s ease-in-out; background: #000; }
        .media-container.visible { opacity: 1; }
        img, video { width: 100%; height: 100%; object-fit: cover; display: block; }
        #brightness-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; pointer-events: none; z-index: 9999; opacity: 0; transition: opacity 2s ease-in-out; }
    </style>
</head>
<body>
    <div id="brightness-overlay"></div>
    <div id="container1" class="media-container visible"></div>
    <div id="container2" class="media-container"></div>

    <script>
        var allMedia = [];
        var playlist = [];
        var currentIndex = -1;
        var activeContainerId = 'container1';
        var latestImageId = null;
        
        var config = { duration: 10, mode: 'slideshow', newest_count: 5, brightness: 100, night_mode: false };

        // --- RAM SCHUTZ: Seite alle 4 Stunden komplett neu laden ---
        // Das verhindert, dass der Speicher voll läuft (Memory Leak Protection)
        setTimeout(() => {
            console.log("Wartungs-Reload für RAM-Bereinigung...");
            window.location.reload();
        }, 1000 * 60 * 60 * 4); 


        function fetchConfigAndImages() {
            Promise.all([
                fetch('/api/config').then(r => r.json()),
                fetch('/api/images').then(r => r.json())
            ]).then(([newConfig, newImages]) => {
                
                if (newImages.length > 0) {
                    const currentTopImage = newImages[0].url;
                    if (latestImageId !== null && latestImageId !== currentTopImage) {
                        currentIndex = -1; 
                    }
                    latestImageId = currentTopImage;
                }

                config = newConfig;
                allMedia = newImages;
                
                // Cache für Offline-Modus befüllen
                cacheAllMedia(newImages);

                updatePlaylist();
                updateBrightness();
            })
            .catch(err => {
                console.log("Offline Modus aktiv (oder API Fehler).", err);
            });
        }

        // --- Robuste Caching Funktion (v3) ---
        async function cacheAllMedia(mediaItems) {
            if (!('caches' in window)) return;
            try {
                const cache = await caches.open('rahmen-cache-v3');
                mediaItems.forEach(item => {
                    const url = '/static/images/' + item.url;
                    const encodedUrl = encodeURI(url);
                    cache.match(encodedUrl).then(response => {
                        if (!response) {
                            cache.add(encodedUrl).catch(e => console.error("Fehler Caching:", item.url));
                        }
                    });
                });
            } catch(e) { console.log("Cache Fehler", e); }
        }

        function updatePlaylist() {
            if (config.forced_image) {
                const forced = allMedia.find(m => m.url === config.forced_image);
                if (forced) { playlist = [forced]; return; }
            }
            if (config.mode === 'newest') {
                playlist = allMedia.slice(0, config.newest_count);
            } else {
                playlist = allMedia;
            }
        }

        function isNightTime() {
            if (!config.night_mode || !config.night_start || !config.night_end) return false;
            const now = new Date();
            const cm = now.getHours() * 60 + now.getMinutes();
            const [sH, sM] = config.night_start.split(':').map(Number);
            const [eH, eM] = config.night_end.split(':').map(Number);
            const start = sH * 60 + sM; const end = eH * 60 + eM;
            return (start < end) ? (cm >= start && cm < end) : (cm >= start || cm < end);
        }

        function updateBrightness() {
            let target = isNightTime() ? (config.night_brightness || 20) : config.brightness;
            document.getElementById('brightness-overlay').style.opacity = 1 - (target / 100);
        }

        // --- RAM CLEANUP HELPER ---
        function cleanupContainer(container) {
            // Sucht nach Videos im Container und stoppt sie explizit
            const video = container.querySelector('video');
            if (video) {
                video.pause();
                video.removeAttribute('src'); // Quelle entfernen
                video.load(); // Leeren erzwingen
            }
            container.innerHTML = ''; // HTML entfernen
        }

        function playNext() {
            if (playlist.length === 0) { setTimeout(playNext, 2000); return; }

            let nextIndex = (currentIndex + 1) % playlist.length;
            if (nextIndex >= playlist.length) nextIndex = 0; 
            if (playlist.length === 1) nextIndex = 0;

            var item = playlist[nextIndex];
            currentIndex = nextIndex;

            var nextContainerId = (activeContainerId === 'container1') ? 'container2' : 'container1';
            var nextDiv = document.getElementById(nextContainerId);
            var currentDiv = document.getElementById(activeContainerId);
            
            // WICHTIG: Speicher aufräumen bevor wir Neues reinladen
            cleanupContainer(nextDiv);
            
            var el;
            var duration = (isNightTime() ? (config.night_duration || config.duration) : config.duration) * 1000;

            if (item.type === 'video') {
                el = document.createElement('video');
                el.src = "/static/images/" + item.url;
                el.muted = true; el.autoplay = true; el.playsInline = true;
                el.style.objectPosition = "center center"; 
                el.oncanplay = () => {
                   nextDiv.classList.add('visible'); currDiv.classList.remove('visible');
                   activeContainerId = nextDiv.id;
                   el.play().catch(e=>console.log(e));
                };
                
                if (playlist.length === 1) {
                    el.loop = true;
                    setTimeout(playNext, 60000); 
                } else {
                    el.onended = playNext;
                }
                el.onerror = () => setTimeout(playNext, 1000);
            } else {
                el = document.createElement('img');
                el.src = "/static/images/" + item.url;
                el.style.objectPosition = item.focus_x + "% " + item.focus_y + "%";
                el.onload = () => {
                   nextDiv.classList.add('visible'); currDiv.classList.remove('visible');
                   activeContainerId = nextDiv.id;
                   setTimeout(playNext, duration);
                };
                el.onerror = () => setTimeout(playNext, 1000);
            }
            nextDiv.appendChild(el);
        }

        fetchConfigAndImages();
        setInterval(fetchConfigAndImages, 10000); 
        setInterval(updateBrightness, 60000);
        setTimeout(playNext, 1000);

        // PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('Service Worker OK'))
                    .catch(err => console.log('SW Fail', err));
            });
        }
    </script>
</body>
</html>