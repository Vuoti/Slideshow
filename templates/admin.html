<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #fff; padding: 20px; }
        
        /* Settings Box */
        .settings-box { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;}
        .settings-group { display: flex; align-items: center; gap: 10px; }
        input[type="number"] { width: 60px; padding: 5px; border-radius: 4px; border: none; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .grid-item { position: relative; cursor: pointer; aspect-ratio: 1/1; overflow: hidden; border: 2px solid transparent; }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .grid-item:hover { border-color: #007aff; }

        /* Editor */
        #editor { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        #editor-img-container { position: relative; max-width: 90vw; max-height: 60vh; border: 2px solid #fff; overflow: hidden; }
        #editor-img { max-width: 100%; max-height: 60vh; display: block; }
        #focus-point { position: absolute; width: 20px; height: 20px; background: rgba(255, 0, 0, 0.7); border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }

        .controls { margin-top: 20px; display: flex; gap: 10px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; }
        .btn-save { background: #007aff; color: white; }
        .btn-cancel { background: #444; color: white; }
        .btn-delete { background: #ff3b30; color: white; margin-left: 20px;}
        
        .upload-area { border: 2px dashed #555; padding: 20px; text-align: center; margin-bottom: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div class="settings-box">
        <h3>‚öôÔ∏è Konfiguration</h3>
        
        <div style="display: flex; gap: 40px; flex-wrap: wrap;">
            
            <div class="settings-col">
                <h4>Allgemein</h4>
                <div class="settings-group">
                    <label>Modus:</label>
                    <select id="modeInput" onchange="toggleNewestCount()">
                        <option value="slideshow">Alle Bilder (Shuffle/Loop)</option>
                        <option value="newest">Nur die Neuesten</option>
                    </select>
                </div>
                
                <div class="settings-group" id="newestCountGroup" style="display:none;">
                    <label>Anzahl der Neuesten:</label>
                    <input type="number" id="newestCountInput" min="1" max="50" style="width: 50px">
                </div>

                <div class="settings-group">
                    <label>Anzeigedauer (Sek):</label>
                    <input type="number" id="durationInput" min="3">
                </div>

                <div class="settings-group">
                    <label>Helligkeit Tag (<span id="brightVal">100</span>%):</label>
                    <input type="range" id="brightnessInput" min="0" max="100" oninput="document.getElementById('brightVal').innerText = this.value">
                </div>
            </div>

            <div class="settings-col" style="border-left: 1px solid #555; padding-left: 20px;">
                <h4>üåô Nachtmodus</h4>
                <div class="settings-group">
                    <label>Aktivieren:</label>
                    <input type="checkbox" id="nightModeCheck">
                </div>
                <div class="settings-group">
                    <label>Zeitraum:</label>
                    <input type="time" id="nightStartInput"> bis <input type="time" id="nightEndInput">
                </div>
                <div class="settings-group">
                    <label>Helligkeit Nacht (<span id="nightBrightVal">20</span>%):</label>
                    <input type="range" id="nightBrightnessInput" min="0" max="100" oninput="document.getElementById('nightBrightVal').innerText = this.value">
                </div>
            </div>
        </div>

        <button class="btn-save" style="margin-top: 20px; width: 100%;" onclick="saveSettings()">Einstellungen Speichern</button>
    </div>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        + Bilder hochladen
        <input type="file" id="fileInput" multiple style="display:none" onchange="uploadFiles(this.files)">
    </div>

    <div class="grid" id="grid">Loading...</div>

    <div id="editor">
        <h3 style="color:white; margin-bottom:10px;">Fokus setzen (Klick) oder L√∂schen</h3>
        <div id="editor-img-container" onclick="setFocus(event)">
            <img id="editor-img" src="">
            <div id="focus-point"></div>
        </div>
        <div class="controls">
            <button class="btn-cancel" onclick="closeEditor()">Abbrechen</button>
            <button class="btn-delete" onclick="deleteImage()">L√∂schen üóëÔ∏è</button>
            <button class="btn-save" onclick="saveCrop()">Speichern</button>
        </div>
    </div>

    <script>
        let currentFilename = '';
        let currentX = 50;
        let currentY = 50;

        // --- Config Laden ---
        fetch('/api/config')
            .then(res => res.json())
            .then(data => {
                document.getElementById('durationInput').value = data.duration;
                document.getElementById('modeInput').value = data.mode;
                document.getElementById('newestCountInput').value = data.newest_count || 5;
                
                document.getElementById('brightnessInput').value = data.brightness;
                document.getElementById('brightVal').innerText = data.brightness;
                
                document.getElementById('nightModeCheck').checked = data.night_mode;
                document.getElementById('nightStartInput').value = data.night_start;
                document.getElementById('nightEndInput').value = data.night_end;
                document.getElementById('nightBrightnessInput').value = data.night_brightness;
                document.getElementById('nightBrightVal').innerText = data.night_brightness;

                toggleNewestCount();
            });

        function toggleNewestCount() {
            const mode = document.getElementById('modeInput').value;
            document.getElementById('newestCountGroup').style.display = (mode === 'newest') ? 'flex' : 'none';
        }

        function saveSettings() {
            const data = {
                duration: parseInt(document.getElementById('durationInput').value),
                mode: document.getElementById('modeInput').value,
                newest_count: parseInt(document.getElementById('newestCountInput').value),
                brightness: parseInt(document.getElementById('brightnessInput').value),
                night_mode: document.getElementById('nightModeCheck').checked,
                night_start: document.getElementById('nightStartInput').value,
                night_end: document.getElementById('nightEndInput').value,
                night_brightness: parseInt(document.getElementById('nightBrightnessInput').value)
            };

            fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(() => alert('Einstellungen gespeichert!'));
        }
        

        function saveSettings() {
            const duration = parseInt(document.getElementById('durationInput').value);
            const mode = document.getElementById('modeInput').value;
            fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ duration: duration, mode: mode })
            }).then(() => alert('Einstellungen gespeichert!'));
        }

        // --- Bilder Laden ---
        function loadImages() {
            fetch('/api/images')
                .then(res => res.json())
                .then(data => {
                    const grid = document.getElementById('grid');
                    grid.innerHTML = '';
                    data.forEach(img => {
                        const div = document.createElement('div');
                        div.className = 'grid-item';
                        div.innerHTML = `<img src="/static/images/${img.url}" style="object-position: ${img.focus_x}% ${img.focus_y}%">`;
                        div.onclick = () => openEditor(img);
                        grid.appendChild(div);
                    });
                });
        }

        // --- Editor Logik ---
        function openEditor(imgData) {
            currentFilename = imgData.url;
            currentX = imgData.focus_x;
            currentY = imgData.focus_y;
            document.getElementById('editor-img').src = '/static/images/' + imgData.url;
            document.getElementById('editor').style.display = 'flex';
            document.getElementById('editor-img').onload = () => updateCrosshair();
        }

        function setFocus(event) {
            const rect = event.target.getBoundingClientRect();
            currentX = Math.round(((event.clientX - rect.left) / rect.width) * 100);
            currentY = Math.round(((event.clientY - rect.top) / rect.height) * 100);
            updateCrosshair();
        }

        function updateCrosshair() {
            const point = document.getElementById('focus-point');
            point.style.left = currentX + '%';
            point.style.top = currentY + '%';
        }

        function saveCrop() {
            fetch('/api/update_crop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ filename: currentFilename, x: currentX, y: currentY })
            }).then(() => { closeEditor(); loadImages(); });
        }

        function deleteImage() {
            if(!confirm("Wirklich l√∂schen?")) return;
            fetch('/api/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ filename: currentFilename })
            }).then(() => { closeEditor(); loadImages(); });
        }

        function closeEditor() { document.getElementById('editor').style.display = 'none'; }
        
        function uploadFiles(files) {
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('file', files[i]);
                fetch('/api/upload', {method: 'POST', body: formData})
                .then(() => { if(i === files.length -1) setTimeout(loadImages, 1000); });
            }
        }

        loadImages();
    </script>
</body>
</html>