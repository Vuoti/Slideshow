<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilderrahmen Admin</title>
    <style>
        :root { 
            --accent: #007aff; 
            --bg: #1c1c1e; 
            --card: #2c2c2e; 
            --text: #f2f2f7; 
            --danger: #ff453a; 
            --success: #32d74b; 
            /* Ziel-Format: 3 / 3.5 */
            --aspect-ratio: 3 / 3.5; 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        h3, h4 { margin-top: 0; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Settings Cards */
        .settings-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #aaa; }
        input, select { width: 100%; padding: 10px; background: #444; border: none; border-radius: 8px; color: white; box-sizing: border-box; }
        input[type="range"] { padding: 0; }
        .row { display: flex; gap: 10px; }
        
        /* Buttons */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1em; transition: transform 0.05s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: black; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-upload { border: 2px dashed #555; background: transparent; color: #aaa; margin-bottom: 30px; }
        .btn-upload:hover { border-color: var(--accent); color: var(--accent); }

        /* Grid - Optimiert f√ºr Performance und Speed */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
        .grid-item { 
            position: relative; 
            aspect-ratio: var(--aspect-ratio); 
            border-radius: 8px; overflow: hidden; cursor: pointer; 
            border: 3px solid transparent; 
            /* SCHNELLERER HOVER: */
            transition: transform 0.1s ease-out, border-color 0.1s ease-out; 
            background: #000; 
            will-change: transform; /* Performance Boost */
        }
        .grid-item:hover { transform: scale(1.05); border-color: var(--accent); z-index: 10; }
        .grid-item.active-freeze { border-color: var(--success); box-shadow: 0 0 15px var(--success); }
        .grid-item img, .grid-item video { width: 100%; height: 100%; object-fit: cover; display: block; pointer-events: none; }
        
        #freeze-bar { 
            background: var(--accent); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; 
            display: none; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,122,255,0.4);
        }

        /* Editor Modal */
        #editor { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        
        /* FIX F√úR MOBILE ASPECT RATIO: 
           display: inline-block + width: fit-content sorgt daf√ºr, 
           dass der Wrapper exakt so gro√ü ist wie das Bild darin.
        */
        .editor-wrapper { 
            position: relative; 
            display: inline-block; /* WICHTIG */
            width: fit-content;    /* WICHTIG */
            max-width: 100%; 
            max-height: 70vh; 
            margin-bottom: 20px; 
            overflow: hidden; 
            border-radius: 4px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            cursor: crosshair; 
        }
        
        #editor-img, #editor-video { 
            display: block; 
            max-width: 100%; 
            max-height: 70vh; 
            /* Verhindert Verzerrung durch CSS */
            width: auto; 
            height: auto;
        }

        #crop-box {
            position: absolute;
            top: 0; left: 0;
            border: 2px solid var(--success);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            pointer-events: none;
            transition: all 0.1s ease-out;
        }
        
        #focus-indicator {
            position: absolute;
            width: 10px; height: 10px;
            background: red; border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px white;
        }

        .editor-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 400px; margin-bottom: 50px; }
        .btn-freeze { background: var(--success); color: black; grid-column: span 2; }
    </style>
</head>
<body>
    <div class="container">
        
        <div id="freeze-bar">
            <span>‚ùÑÔ∏è <b>Ein Bild ist fixiert!</b></span>
            <button class="btn" style="width: auto; background: white; color: black; padding: 5px 15px;" onclick="unfreeze()">L√∂sen</button>
        </div>

        <div class="settings-container">
            <div class="card">
                <h3>‚öôÔ∏è Allgemein</h3>
                <div class="form-group">
                    <label>Modus</label>
                    <select id="modeInput" onchange="toggleNewestCount()">
                        <option value="slideshow">Diashow (Alle Bilder)</option>
                        <option value="newest">Nur die Neuesten</option>
                    </select>
                </div>
                <div class="form-group" id="newestCountGroup" style="display:none;">
                    <label>Anzahl der Neuesten</label>
                    <input type="number" id="newestCountInput" min="1" max="50">
                </div>
                <div class="form-group">
                    <label>Anzeigedauer (Sekunden)</label>
                    <input type="number" id="durationInput" min="3">
                </div>
                <div class="form-group">
                    <label>Helligkeit (<span id="brightVal">100</span>%)</label>
                    <input type="range" id="brightnessInput" min="0" max="100" oninput="document.getElementById('brightVal').innerText=this.value">
                </div>
            </div>

            <div class="card">
                <h3>üåô Nachtmodus</h3>
                <div class="row">
                    <div class="form-group" style="flex:1">
                         <label>Aktiv?</label>
                         <input type="checkbox" id="nightModeCheck" style="width: 20px; height: 20px;">
                    </div>
                    <div class="form-group" style="flex:3">
                        <label>Dauer Nacht (Sek)</label>
                        <input type="number" id="nightDurationInput">
                    </div>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>Start</label>
                        <input type="time" id="nightStartInput">
                    </div>
                    <div class="form-group">
                        <label>Ende</label>
                        <input type="time" id="nightEndInput">
                    </div>
                </div>
                <div class="form-group">
                    <label>Helligkeit Nacht (<span id="nightBrightVal">20</span>%)</label>
                    <input type="range" id="nightBrightnessInput" min="0" max="100" oninput="document.getElementById('nightBrightVal').innerText=this.value">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Einstellungen Speichern</button>
            </div>
        </div>

        <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">
            üì∏ Neues Bild/Video hochladen
        </button>
        <input type="file" id="fileInput" multiple style="display:none" onchange="uploadFiles(this.files)">

        <div class="grid" id="grid"></div>
    </div>

    <div id="editor">
        <h3 style="margin-bottom: 5px;">Ausschnitt anpassen</h3>
        <p style="font-size: 0.8em; color: #aaa; margin-top: 0; margin-bottom: 15px;">Klicke in das Bild, um den sichtbaren Bereich zu verschieben.</p>
        
        <div class="editor-wrapper" onclick="setFocus(event)" id="editor-wrapper">
            <img id="editor-img" src="" style="display:none;">
            <video id="editor-video" src="" muted loop playsinline style="display:none;"></video>
            <div id="crop-box">
                <div id="focus-indicator"></div>
            </div>
        </div>
        
        <div class="editor-actions">
            <button class="btn btn-freeze" onclick="freezeImage()">‚ú® NUR DIESES ANZEIGEN</button>
            <button class="btn btn-primary" onclick="saveCrop()">Speichern</button>
            <button class="btn btn-danger" onclick="deleteImage()">L√∂schen</button>
            <button class="btn" style="background:#555; grid-column: span 2;" onclick="closeEditor()">Abbrechen</button>
        </div>
    </div>

    <script>
        let currentFilename = '';
        let currentType = 'image';
        let currentX = 50; let currentY = 50;
        let globalConfig = {};
        
        const TARGET_RATIO = 3 / 3.5;

        function loadAll() {
            fetch('/api/config').then(r=>r.json()).then(data => {
                globalConfig = data;
                document.getElementById('durationInput').value = data.duration;
                document.getElementById('modeInput').value = data.mode;
                document.getElementById('newestCountInput').value = data.newest_count || 5;
                document.getElementById('brightnessInput').value = data.brightness;
                document.getElementById('brightVal').innerText = data.brightness;
                document.getElementById('nightModeCheck').checked = data.night_mode;
                document.getElementById('nightStartInput').value = data.night_start;
                document.getElementById('nightEndInput').value = data.night_end;
                document.getElementById('nightDurationInput').value = data.night_duration || 30;
                document.getElementById('nightBrightnessInput').value = data.night_brightness;
                document.getElementById('nightBrightVal').innerText = data.night_brightness;

                const bar = document.getElementById('freeze-bar');
                if (data.forced_image) {
                    bar.style.display = 'flex';
                    const shortName = data.forced_image.length > 20 ? '...' + data.forced_image.slice(-15) : data.forced_image;
                    bar.innerHTML = `<span>‚ùÑÔ∏è <b>${shortName}</b> ist fixiert!</span> <button class="btn" style="width: auto; background: white; color: black; padding: 5px 15px;" onclick="unfreeze()">L√∂sen</button>`;
                } else {
                    bar.style.display = 'none';
                }

                toggleNewestCount();
                loadImages(); 
            });
        }

        function loadImages() {
            fetch('/api/images').then(r=>r.json()).then(data => {
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'grid-item';
                    if (globalConfig.forced_image === item.url) div.classList.add('active-freeze');
                    
                    let contentHTML = '';
                    if (item.type === 'video') {
                        // WIEDER MIT AUTOPLAY
                        contentHTML = `<video src="/static/images/${item.url}" autoplay muted loop playsinline style="object-position: ${item.focus_x}% ${item.focus_y}%"></video>`;
                    } else {
                        contentHTML = `<img src="/static/images/${item.url}" loading="lazy" style="object-position: ${item.focus_x}% ${item.focus_y}%">`;
                    }

                    div.innerHTML = contentHTML;
                    div.onclick = () => openEditor(item);
                    grid.appendChild(div);
                });
            });
        }

        function toggleNewestCount() {
            const mode = document.getElementById('modeInput').value;
            document.getElementById('newestCountGroup').style.display = (mode === 'newest') ? 'block' : 'none';
        }

        function saveSettings(overrideData = null) {
            const data = overrideData || {
                duration: parseInt(document.getElementById('durationInput').value),
                mode: document.getElementById('modeInput').value,
                newest_count: parseInt(document.getElementById('newestCountInput').value),
                brightness: parseInt(document.getElementById('brightnessInput').value),
                night_mode: document.getElementById('nightModeCheck').checked,
                night_start: document.getElementById('nightStartInput').value,
                night_end: document.getElementById('nightEndInput').value,
                night_duration: parseInt(document.getElementById('nightDurationInput').value),
                night_brightness: parseInt(document.getElementById('nightBrightnessInput').value)
            };

            fetch('/api/config', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(() => {
                if(!overrideData) alert('Gespeichert!');
                loadAll();
            });
        }

        function freezeImage() {
            const newConfig = { ...globalConfig, forced_image: currentFilename };
            saveSettings(newConfig);
            closeEditor();
        }

        function unfreeze() {
            const newConfig = { ...globalConfig, forced_image: null };
            saveSettings(newConfig);
        }

        // --- Editor Logik ---
        function openEditor(item) {
            currentFilename = item.url;
            currentType = item.type;
            currentX = item.focus_x; 
            currentY = item.focus_y;

            const editImg = document.getElementById('editor-img');
            const editVid = document.getElementById('editor-video');
            const url = '/static/images/' + item.url;

            if (item.type === 'video') {
                editImg.style.display = 'none';
                editVid.style.display = 'block';
                editVid.src = url;
                editVid.play(); 
                // Metadata warten f√ºr korrekte Gr√∂√üe
                editVid.onloadedmetadata = () => updateCropMask(editVid.videoWidth, editVid.videoHeight);
                // Falls schon geladen (Cache):
                if(editVid.readyState >= 1) updateCropMask(editVid.videoWidth, editVid.videoHeight);
            } else {
                editVid.style.display = 'none';
                editImg.style.display = 'block';
                editImg.src = url;
                editImg.onload = () => updateCropMask(editImg.naturalWidth, editImg.naturalHeight);
                if(editImg.complete) updateCropMask(editImg.naturalWidth, editImg.naturalHeight);
            }

            document.getElementById('editor').style.display = 'flex';
        }

        function setFocus(event) {
            // Umrechnung auf Bild-Gr√∂√üe
            const wrapper = document.getElementById('editor-wrapper');
            const rect = wrapper.getBoundingClientRect();
            
            let x = ((event.clientX - rect.left) / rect.width) * 100;
            let y = ((event.clientY - rect.top) / rect.height) * 100;
            
            currentX = Math.round(Math.max(0, Math.min(100, x)));
            currentY = Math.round(Math.max(0, Math.min(100, y)));
            
            if(currentType === 'video') {
                const v = document.getElementById('editor-video');
                updateCropMask(v.videoWidth, v.videoHeight);
            } else {
                const i = document.getElementById('editor-img');
                updateCropMask(i.naturalWidth, i.naturalHeight);
            }
        }

        function updateCropMask(mediaW, mediaH) {
            const box = document.getElementById('crop-box');
            // Schutz vor Division durch 0
            if(!mediaW || !mediaH) return;

            const mediaRatio = mediaW / mediaH;
            let boxW, boxH;

            if (mediaRatio > TARGET_RATIO) {
                // Bild ist breiter
                boxH = 100;
                boxW = (mediaH * TARGET_RATIO / mediaW) * 100;
            } else {
                // Bild ist h√∂her
                boxW = 100;
                boxH = (mediaW / TARGET_RATIO / mediaH) * 100;
            }

            const availableX = 100 - boxW;
            const availableY = 100 - boxH;
            
            const left = (currentX / 100) * availableX;
            const top = (currentY / 100) * availableY;

            box.style.width = boxW + '%';
            box.style.height = boxH + '%';
            box.style.left = left + '%';
            box.style.top = top + '%';
        }

        function saveCrop() {
            fetch('/api/update_crop', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ filename: currentFilename, x: currentX, y: currentY }) })
            .then(() => { closeEditor(); loadImages(); });
        }
        function deleteImage() {
            if(!confirm("Wirklich l√∂schen?")) return;
            fetch('/api/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ filename: currentFilename }) })
            .then(() => { closeEditor(); loadAll(); });
        }
        function closeEditor() { 
            document.getElementById('editor').style.display = 'none'; 
            document.getElementById('editor-video').pause();
        }
        
        function uploadFiles(files) {
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('file', files[i]);
                fetch('/api/upload', {method: 'POST', body: formData})
                .then(() => { if(i === files.length -1) setTimeout(loadAll, 1000); });
            }
        }

        loadAll();
    </script>
</body>
</html>